# FFmpeg patch/extension for embedding waveform data in an HLS playlist

## Synopsis

This is an experimental patch for ffmpeg/libavformat 4.4 that adds some additional options to allow embedding of waveform visualisation data points in an HLS playlist with a custom `EXT-X-PEAKDATA` header attached to every segment.

## Why?

1) As a learning excercise in order to better understand the ffmpeg stack
2) For feasibility testing whether it possible to use server-side generated audio visualizations in web applications (possibly in conjuction with [hls.js](https://github.com/video-dev/hls.js/)

## How?

After applying the patch, you can try out something like:

```
./ffmpeg -i /tmp/test.flac -f hls -hls_audio_peaks true -hls_playlist_type vod /tmp/stream.m3u8
```

## What?

- `hls_audio_peaks true|false => toggles waveform embedding in the HLS playlist`
- `hls_audio_peaks_window <n> (defaults to n=1000) => sets the window size for peak calculation`

## How does it look like?

Similar to the following. Each segment get an `EXT-X-PEAKDATA` containing a CSV row of data points that may be used for visualisation purposes.

```
#EXTM3U
#EXT-X-VERSION:3
#EXT-X-TARGETDURATION:2
#EXT-X-MEDIA-SEQUENCE:0
#EXT-X-PLAYLIST-TYPE:VOD
#EXTINF:2.048000,
#EXT-X-PEAKDATA:0.2,5.7,5.6,5.7,5.6,5.6,5.6,5.5,5.6,5.6,5.6,5.5,5.6,5.6,5.6,5.5,5.5
stream0.ts
#EXTINF:2.048000,
#EXT-X-PEAKDATA:5.6,5.6,5.6,5.5,5.6,5.6,5.6,5.5,5.6,5.6,5.6,5.5,5.6,5.6,5.6,5.5,5.4
stream1.ts
#EXTINF:1.920000,
#EXT-X-PEAKDATA:5942.5,666.1,683.5,687.5,690.5,690.0,689.3,683.4,6027.7,660.1,682.1,687.6,689.8,692.8,688.4,639.7
stream2.ts
#EXTINF:2.048000,
#EXT-X-PEAKDATA:687.7,6059.8,679.6,687.6,683.3,678.8,679.3,684.2,681.0,5845.9,675.4,687.9,682.3,679.7,680.5,682.6,698.0
stream3.ts
#EXTINF:2.048000,
#EXT-X-PEAKDATA:5850.9,669.5,680.2,679.6,683.3,688.1,690.7,685.1,5966.0,664.4,680.3,12735.4,12735.3,7696.1,3906.5,1156.9,672.5
stream4.ts
#EXTINF:1.920000,
#EXT-X-PEAKDATA:5876.2,669.6,687.4,691.2,690.4,689.1,683.3,679.5,6055.6,660.9,687.6,683.4,689.8,691.3,683.6,619.3
stream5.ts
#EXTINF:2.048000,
#EXT-X-PEAKDATA:2430.1,5361.8,679.6,687.0,682.0,680.1,680.2,672.0,2426.4,5364.1,689.8,686.9,680.9,678.8,680.3,681.9,694.5
stream6.ts
#EXTINF:1.920000,
#EXT-X-PEAKDATA:5963.3,666.9,679.3,680.4,684.2,689.3,692.8,689.5,6051.4,664.0,680.1,680.2,684.3,689.1,689.9,677.2
stream7.ts
#EXTINF:2.048000,
#EXT-X-PEAKDATA:680.9,6060.3,680.4,691.8,690.8,685.5,682.4,679.4,673.8,5849.4,666.3,690.4,689.7,686.6,680.9,678.6,658.6
stream8.ts
#EXTINF:2.048000,
#EXT-X-PEAKDATA:5849.8,676.8,685.5,682.0,679.8,680.8,685.6,677.2,5966.4,677.7,13854.4,909.8,11182.6,13592.4,9304.8,5033.2,964.8
stream9.ts
#EXTINF:1.920000,
#EXT-X-PEAKDATA:5967.3,665.7,680.2,683.5,687.5,691.2,691.2,687.7,6058.5,658.4,679.8,683.3,688.1,690.8,691.8,647.9
stream10.ts
#EXTINF:2.048000,
#EXT-X-PEAKDATA:673.8,5849.7,681.4,691.4,685.9,682.7,680.7,669.9,661.2,5850.7,692.3,689.6,686.2,681.0,680.1,681.2,682.6
stream11.ts
#EXTINF:2.048000,
#EXT-X-PEAKDATA:5964.6,671.5,682.7,678.5,678.6,684.0,687.8,683.6,5844.1,668.2,682.4,679.7,679.7,683.9,688.5,689.1,696.0
stream12.ts
#EXTINF:1.920000,
#EXT-X-PEAKDATA:6058.7,669.5,683.7,688.3,691.6,690.3,687.0,681.8,6058.0,657.2,682.8,688.4,691.2,691.2,684.4,619.0
stream13.ts
#EXTINF:2.048000,
#EXT-X-PEAKDATA:2429.7,5362.7,679.9,686.1,683.1,680.1,680.5,670.9,2518.1,5451.4,3091.7,13524.0,9766.3,4949.7,15280.8,10614.4,8006.1
stream14.ts
#EXTINF:1.920000,
#EXT-X-PEAKDATA:7600.6,1061.6,755.0,680.3,684.3,688.0,692.1,689.4,6050.8,663.5,678.3,679.7,683.4,689.5,691.1,677.5
stream15.ts
#EXTINF:2.048000,
#EXT-X-PEAKDATA:680.7,6058.3,680.2,691.6,691.5,685.5,681.2,678.8,673.0,5850.2,666.2,691.9,689.4,688.4,685.1,679.7,638.2
stream16.ts
#EXTINF:2.048000,
#EXT-X-PEAKDATA:5963.4,675.5,690.9,685.9,680.9,678.3,681.6,684.6,5879.5,674.1,688.8,686.3,681.9,678.8,681.2,683.5,724.4
stream17.ts
#EXTINF:1.920000,
#EXT-X-PEAKDATA:6056.3,665.0,679.4,680.4,684.9,688.3,692.2,682.7,5848.9,662.6,679.6,680.9,683.6,689.9,682.6,644.7
stream18.ts
#EXTINF:2.048000,
#EXT-X-PEAKDATA:4370.9,3941.2,679.5,690.5,689.2,685.4,680.9,671.0,4528.1,3946.5,15826.3,8963.2,8448.5,13845.0,8320.1,4934.5,1481.1
stream19.ts
#EXTINF:2.048000,
#EXT-X-PEAKDATA:5902.8,675.8,687.0,682.1,680.1,680.3,685.4,687.9,6059.8,671.4,685.7,681.9,680.1,681.6,685.8,690.4,712.6
stream20.ts
#EXTINF:1.920000,
#EXT-X-PEAKDATA:6062.0,665.4,680.5,684.3,688.1,692.6,685.3,662.7,5849.0,657.2,680.3,682.3,688.8,690.4,685.4,621.9
stream21.ts
#EXTINF:2.048000,
#EXT-X-PEAKDATA:5966.3,675.1,691.0,690.3,687.2,683.7,680.4,679.0,5967.4,667.2,690.5,691.9,688.7,685.9,680.6,678.8,685.3
stream22.ts
#EXTINF:1.920000,
#EXT-X-PEAKDATA:6059.6,672.1,685.2,681.0,679.4,681.3,685.8,681.8,5849.9,675.5,685.9,680.5,679.2,681.5,679.9,697.7
stream23.ts
#EXTINF:2.048000,
#EXT-X-PEAKDATA:5723.8,1378.6,682.7,686.5,690.7,691.4,689.2,680.6,5884.1,1326.7,14861.0,12076.0,5105.6,14942.8,8711.3,5811.9,3679.9
stream24.ts
#EXTINF:2.048000,
#EXT-X-PEAKDATA:5879.6,869.3,691.6,689.1,684.6,681.5,679.7,680.9,6058.9,672.7,691.9,689.2,685.2,680.9,680.0,682.0,714.0
stream25.ts
#EXTINF:1.920000,
#EXT-X-PEAKDATA:6060.4,667.5,680.4,678.0,681.5,685.9,682.8,668.0,5850.5,670.5,681.1,679.1,680.7,685.3,682.2,670.5
stream26.ts
#EXTINF:2.048000,
#EXT-X-PEAKDATA:5964.5,668.7,686.3,691.3,690.6,688.3,683.8,675.0,5846.9,661.2,686.2,689.3,692.3,680.8,687.0,682.3,649.9
stream27.ts
#EXTINF:2.048000,
#EXT-X-PEAKDATA:6056.7,679.9,690.2,688.3,684.0,681.1,679.9,674.4,5848.9,674.5,692.6,689.1,685.2,680.3,677.9,658.5,9399.8
stream28.ts
#EXTINF:1.920000,
#EXT-X-PEAKDATA:675.2,684.9,680.9,678.8,680.6,686.1,684.6,5967.5,668.2,10731.8,6923.9,10110.8,12522.8,10172.4,5745.9,4875.6
stream29.ts
#EXTINF:2.048000,
#EXT-X-PEAKDATA:6142.9,1035.5,687.7,691.4,690.4,688.0,683.2,677.6,6057.2,557.2,6.0,5.7,5.6,5.6,5.5,5.6,5.7
stream30.ts
#EXTINF:1.920000,
#EXT-X-PEAKDATA:396.4,691.4,691.1,689.2,682.8,680.1,666.8,4011.0,4310.3,691.7,691.3,687.7,683.0,680.2,359.4,5.6
stream31.ts
#EXTINF:1.792000,
#EXT-X-PEAKDATA:5.6,5.5,5.6,5.6,5.6,5.6,5.6,5.7,5.6,5.6,5.6,5.7,5.6,5.6,5.6
stream32.ts
#EXT-X-ENDLIST
```

# Disclaimer

This is experimental code and no guarantee, warranty or support is provided whatsoever.
